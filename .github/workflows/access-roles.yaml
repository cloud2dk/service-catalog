name: access-roles

env:
  HOME_REGION: eu-central-1
  ACTIVE_REGIONS: eu-central-1,eu-west-1,us-east-1
  SERVICE_ACCOUNT_ID: ${{ vars.SERVICE_ACCOUNT_ID }}
  SAM_CLI_TELEMETRY: 0
  VERSION: 1.1.${{ github.run_number }}

permissions:
  id-token: write
  contents: write

on:
  push:
    branches:
      - main
    paths:
      - 'services/access-roles/**'
      - 'scripts/**'
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Validate manifest.yaml
        working-directory: services/access-roles
        run: |
          ../../scripts/validate.sh manifest.yaml

      - name: build and upload artifacts
        working-directory: services/access-roles
        run: |
          ../../scripts/build.sh

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: artifacts
          path: services/access-roles/artifacts

  dev-publish:
    runs-on: ubuntu-latest
    environment: dev
    needs:
      - build
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: download artifacts
        uses: actions/download-artifact@v4
        with:
          name: artifacts
          path: services/access-roles/artifacts

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.SERVICE_ACCOUNT_ID }}:role/cloud2-github-oicd
          role-session-name: GitHubActions
          aws-region: ${{ env.HOME_REGION }}

      - name: Publish Dev Portfolios
        working-directory: services/access-roles/artifacts
        env:
          VERSION: ${{ env.VERSION }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ../../../scripts/publish.sh dev

  prod-publish:
    runs-on: ubuntu-latest
    environment: prod
    needs:
      - dev-publish
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: download artifacts
        uses: actions/download-artifact@v4
        with:
          name: artifacts
          path: services/access-roles/artifacts

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.SERVICE_ACCOUNT_ID }}:role/cloud2-github-oicd
          role-session-name: GitHubActions
          aws-region: ${{ env.HOME_REGION }}

      - name: Publish Prod Portfolios
        working-directory: services/access-roles/artifacts
        env:
          VERSION: ${{ env.VERSION }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ../../../scripts/publish.sh prod